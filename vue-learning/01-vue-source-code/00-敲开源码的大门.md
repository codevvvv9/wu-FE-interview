## ä¸‹è½½`vue`[æºç ](https://github.com/vuejs/vue)
å­¦ä¹ æºç çš„ç¬¬ä¸€æ­¥æ˜¯ä¸‹è½½æºç ï¼Œç„¶ååˆ†æä»£ç çš„ç›®å½•ç»“æ„ã€‚
### webåº”ç”¨çš„å¤§é—¨
é€šå¸¸ï¼Œ`./src`ç›®å½•æ˜¯æºç ç›®å½•ï¼Œå¯¹äºå½“å‰é¡¹ç›®æ¥è¯´ï¼Œ`src/platforms/web/entry-runtime-with-compiler.js`,ä»¥è¿™ä¸ªæ–‡ä»¶ä½œä¸ºçªç ´å£ï¼Œè¿™åªæ˜¯ä¸€é“é—¨ğŸšªï¼Œè™šæ©ç€ã€‚
```javascript
/* @flow */

import config from 'core/config'
import { warn, cached } from 'core/util/index'
import { mark, measure } from 'core/util/perf'

import Vue from './runtime/index'
import { query } from './util/index'
import { compileToFunctions } from './compiler/index'
import { shouldDecodeNewlines, shouldDecodeNewlinesForHref } from './util/compat'

const idToTemplate = cached(id => {
  const el = query(id)
  return el && el.innerHTML
})

const mount = Vue.prototype.$mount
Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
  el = el && query(el)

  /* istanbul ignore if */
  if (el === document.body || el === document.documentElement) {
    process.env.NODE_ENV !== 'production' && warn(
      `Do not mount Vue to <html> or <body> - mount to normal elements instead.`
    )
    return this
  }

  const options = this.$options
  // resolve template/el and convert to render function
  if (!options.render) {
    let template = options.template
    if (template) {
      if (typeof template === 'string') {
        if (template.charAt(0) === '#') {
          template = idToTemplate(template)
          /* istanbul ignore if */
          if (process.env.NODE_ENV !== 'production' && !template) {
            warn(
              `Template element not found or is empty: ${options.template}`,
              this
            )
          }
        }
      } else if (template.nodeType) {
        template = template.innerHTML
      } else {
        if (process.env.NODE_ENV !== 'production') {
          warn('invalid template option:' + template, this)
        }
        return this
      }
    } else if (el) {
      template = getOuterHTML(el)
    }
    if (template) {
      /* istanbul ignore if */
      if (process.env.NODE_ENV !== 'production' && config.performance && mark) {
        mark('compile')
      }

      const { render, staticRenderFns } = compileToFunctions(template, {
        outputSourceRange: process.env.NODE_ENV !== 'production',
        shouldDecodeNewlines,
        shouldDecodeNewlinesForHref,
        delimiters: options.delimiters,
        comments: options.comments
      }, this)
      options.render = render
      options.staticRenderFns = staticRenderFns

      /* istanbul ignore if */
      if (process.env.NODE_ENV !== 'production' && config.performance && mark) {
        mark('compile end')
        measure(`vue ${this._name} compile`, 'compile', 'compile end')
      }
    }
  }
  return mount.call(this, el, hydrating)
}

/**
 * Get outerHTML of elements, taking care
 * of SVG elements in IE as well.
 */
function getOuterHTML (el: Element): string {
  if (el.outerHTML) {
    return el.outerHTML
  } else {
    const container = document.createElement('div')
    container.appendChild(el.cloneNode(true))
    return container.innerHTML
  }
}

Vue.compile = compileToFunctions

export default Vue


```
å½“æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å†™ä¸‹`import Vue from 'vue'`ï¼Œå°±æ˜¯ä»è¿™ä¸ªæ–‡ä»¶æ¥çš„ï¼Œç»†å¿ƒå¯»æ‰¾è¿™ä¸ªæ–‡ä»¶ï¼Œä¼šå‘ç°ä¸€è¡Œé‡è¦ä»£ç `import Vue from './runtime/index'`

### çº¿ç´¢1-`import Vue from './runtime/index'`

`src/platforms/web/runtime/index.js`æ–‡ä»¶

```javascript
/* @flow */

import Vue from 'core/index'
import config from 'core/config'
import { extend, noop } from 'shared/util'
import { mountComponent } from 'core/instance/lifecycle'
import { devtools, inBrowser } from 'core/util/index'

import {
  query,
  mustUseProp,
  isReservedTag,
  isReservedAttr,
  getTagNamespace,
  isUnknownElement
} from 'web/util/index'

import { patch } from './patch'
import platformDirectives from './directives/index'
import platformComponents from './components/index'

// install platform specific utils
Vue.config.mustUseProp = mustUseProp
Vue.config.isReservedTag = isReservedTag
Vue.config.isReservedAttr = isReservedAttr
Vue.config.getTagNamespace = getTagNamespace
Vue.config.isUnknownElement = isUnknownElement

// install platform runtime directives & components
extend(Vue.options.directives, platformDirectives)
extend(Vue.options.components, platformComponents)

// install platform patch function
Vue.prototype.__patch__ = inBrowser ? patch : noop

// public mount method
Vue.prototype.$mount = function (
  el?: string | Element,
  hydrating?: boolean
): Component {
  el = el && inBrowser ? query(el) : undefined
  return mountComponent(this, el, hydrating)
}

// devtools global hook
/* istanbul ignore next */
if (inBrowser) {
  setTimeout(() => {
    if (config.devtools) {
      if (devtools) {
        devtools.emit('init', Vue)
      } else if (
        process.env.NODE_ENV !== 'production' &&
        process.env.NODE_ENV !== 'test'
      ) {
        console[console.info ? 'info' : 'log'](
          'Download the Vue Devtools extension for a better development experience:\n' +
          'https://github.com/vuejs/vue-devtools'
        )
      }
    }
    if (process.env.NODE_ENV !== 'production' &&
      process.env.NODE_ENV !== 'test' &&
      config.productionTip !== false &&
      typeof console !== 'undefined'
    ) {
      console[console.info ? 'info' : 'log'](
        `You are running Vue in development mode.\n` +
        `Make sure to turn on production mode when deploying for production.\n` +
        `See more tips at https://vuejs.org/guide/deployment.html`
      )
    }
  }, 0)
}

export default Vue

```

### çº¿ç´¢2-`import Vue from 'core/index'`

è¿™ä¸ªçº¿ç´¢éå¸¸å…³é”®ï¼Œå‰ä¸¤è¡Œå‘Šè¯‰æˆ‘ä»¬`Vue`çš„å®šä¹‰å’Œåˆå§‹åŒ–ä¸€äº›å…¨å±€å‡½æ•°
`src/core/index.js`

```javascript
import Vue from './instance/index'
import { initGlobalAPI } from './global-api/index'
import { isServerRendering } from 'core/util/env'
import { FunctionalRenderContext } from 'core/vdom/create-functional-component'

initGlobalAPI(Vue)

Object.defineProperty(Vue.prototype, '$isServer', {
  get: isServerRendering
})

Object.defineProperty(Vue.prototype, '$ssrContext', {
  get () {
    /* istanbul ignore next */
    return this.$vnode && this.$vnode.ssrContext
  }
})

// expose FunctionalRenderContext for ssr runtime helper installation
Object.defineProperty(Vue, 'FunctionalRenderContext', {
  value: FunctionalRenderContext
})

Vue.version = '__VERSION__'

export default Vue

```
## `Vue`çœŸæ­£å®šä¹‰

ç»ˆäºæ‰¾åˆ°ä½ -`src/core/instance/index.js`

```javascript
import { initMixin } from './init'
import { stateMixin } from './state'
import { renderMixin } from './render'
import { eventsMixin } from './events'
import { lifecycleMixin } from './lifecycle'
import { warn } from '../util/index'

function Vue (options) {
  if (process.env.NODE_ENV !== 'production' &&
    !(this instanceof Vue)
  ) {
    warn('Vue is a constructor and should be called with the `new` keyword')
  }
  this._init(options)
}

initMixin(Vue)
stateMixin(Vue)
eventsMixin(Vue)
lifecycleMixin(Vue)
renderMixin(Vue)

export default Vue

```

`Vue`çœŸå®çš„é¢ç›®æ˜¯ä¸€ä¸ªjsä¸­å¸¸è§çš„ç”¨å‡½æ•°æ„å»ºçš„ç±»ã€‚ä»”ç»†çœ‹ä¼¼ä¹æ²¡å•¥ä¸œè¥¿ï¼Œå°±æœ‰ä¸€ä¸ªå†…éƒ¨æ–¹æ³•`_init`ï¼Œå®ƒå“ªæ¥çš„å‘¢ï¼Œæ˜¯ä¸‹é¢çš„`initMixin`åšçš„å¤„ç†ï¼Œå¾€ä¸‹è¿ç»­4ä¸ªmixinåœ¨vueçš„åŸå‹ä¸Šåšäº†ä¸€äº›å¤„ç†ï¼Œä½¿ä¹‹å…·å¤‡äº†å¾ˆå¤šå†…éƒ¨æœ‰ç”¨çš„æ–¹æ³•ï¼Œå…¶ä¸­æˆ‘ä»¬é¦–å…ˆå…³æ³¨`_init`

### `_init`æ–¹æ³•

è¿™ä¸ªé‡è¦çš„æ–¹æ³•é‡Œé¢åšäº†ä»€ä¹ˆå‘¢

```javascript
export function initMixin (Vue: Class<Component>) {
  Vue.prototype._init = function (options?: Object) {
    const vm: Component = this
    // a uid
    vm._uid = uid++

    let startTag, endTag
    /* istanbul ignore if */
    if (process.env.NODE_ENV !== 'production' && config.performance && mark) {
      startTag = `vue-perf-start:${vm._uid}`
      endTag = `vue-perf-end:${vm._uid}`
      mark(startTag)
    }

    // a flag to avoid this being observed
    vm._isVue = true
    // merge options
    if (options && options._isComponent) {
      // optimize internal component instantiation
      // since dynamic options merging is pretty slow, and none of the
      // internal component options needs special treatment.
      initInternalComponent(vm, options)
    } else {
      vm.$options = mergeOptions(
        resolveConstructorOptions(vm.constructor),
        options || {},
        vm
      )
    }
    /* istanbul ignore else */
    if (process.env.NODE_ENV !== 'production') {
      initProxy(vm)
    } else {
      vm._renderProxy = vm
    }
    // expose real self
    vm._self = vm
    initLifecycle(vm)
    initEvents(vm)
    initRender(vm)
    callHook(vm, 'beforeCreate')
    initInjections(vm) // resolve injections before data/props
    initState(vm)
    initProvide(vm) // resolve provide after data/props
    callHook(vm, 'created')

    /* istanbul ignore if */
    if (process.env.NODE_ENV !== 'production' && config.performance && mark) {
      vm._name = formatComponentName(vm, false)
      mark(endTag)
      measure(`vue ${vm._name} init`, startTag, endTag)
    }

    if (vm.$options.el) {
      vm.$mount(vm.$options.el)
    }
  }
}
```

ä¸Šé¢ä»£ç ä¸»è¦åšäº†ä¸€ä¸‹å‡ ä¸ªäº‹ï¼š

1. æ‰“æ ‡è®°ã€‚ç›®å‰è¿˜ä¸çŸ¥é“æœ‰å•¥ç”¨â€¦â€¦
2. åˆå¹¶optionsé€‰é¡¹ã€‚è¿™é‡Œçš„optionså°±æ˜¯ä½ new Vue({...})é‡Œé¢çš„è¿™ä¸ª... ã€‚
3. åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸã€‚
4. åˆå§‹åŒ–äº‹ä»¶ã€‚
5. è§¦å‘`beforeCreate`é’©å­
6. åˆå§‹åŒ–æ³¨å…¥ã€çŠ¶æ€ã€provideã€‚çŠ¶æ€ä¸»è¦æŒ‡çš„æ˜¯propsã€data
7. è§¦å‘`created`é’©å­
8ã€åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¼ å…¥äº†`el`ï¼Œæœ‰è¿™ä¸ªæŒ‚è½½ç‚¹ï¼Œåˆ™å¼€å§‹æŒ‚è½½å®ä¾‹ã€‚